USE [ERPXL_NATOM]
GO

/****** Object:  View [dbo].[ITA_RaportOsAutomatyczny]    Script Date: 7/29/2023 9:13:54 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER view [dbo].[ITA_RaportOsAutomatyczny]

as  

	SELECT

	convert(date,(cdn.tstodate(ZaN_DataWystawienia,0)),120) AS 'Data',
	YEAR(convert(date,(cdn.tstodate(ZaN_DataWystawienia,0)),120)) as 'Rok',
	MONTH(convert(date,(cdn.tstodate(ZaN_DataWystawienia,0)),120)) as 'Miesiąc',
	'OS-'+cast(zan_zamnumer as varchar(5))+'/'+zan_zamseria+'/'+case when len(zan_zammiesiac)=1 then '0'+cast(zan_zammiesiac as varchar(2)) else cast(zan_zammiesiac as varchar(2)) end+'/'+cast(zan_zamrok as varchar(4)) AS 'Numer OS',
	isnull(um.atr_wartosc,'') as 'Numer UM',
	knt_akronim as 'Klient', 
	case when max(isnull(cast(t.atr_wartosc as money),0))=0 then cast(sum(ZaE_Ilosc*ZaE_CenaOferowana) as money) else  max(isnull(cast(t.atr_wartosc as money),0)) end as 'OS Wartość Waluta',
	ZaN_Waluta as 'Waluta OS',
	cast(case when max(isnull(cast(t.atr_wartosc as money),0))=0 then 
	cast(sum(ZaE_Ilosc*ZaE_CenaOferowana)*case when zan_waluta = 'PLN' then 1 else cast(zan_kursl/100 as decimal(15,4)) end as decimal(15,2)) 
	else max(isnull(cast(t.atr_wartosc as money),0))*(case when zan_waluta = 'PLN' then 1 else cast(zan_kursl/100 as decimal(15,4)) end) end as decimal(15,2)) as 'OS Wartość PLN',
	isnull(um_pozycje.[Um Wartość Waluta],0) as 'Um Wartość Waluta',
	isnull(um_pozycje.[Waluta UM],'') as 'Waluta',
	isnull(cast((UmN_KursL/100)*um_pozycje.[Um Wartość Waluta] as decimal(14,2)),0) as 'UM Wartość PLN',
	isnull(aoo.Atr_Wartosc,'') as 'Osoba Odpowiedzialna',
	isnull(apd.Atr_Wartosc,'') as 'Przekazano do'
	from cdn.zamnag
	join cdn.zamelem on zae_gidnumer = zan_gidnumer and zae_gidtyp = zan_gidtyp
	left join cdn.CRMDokumentyLinki on ZaN_GIDNumer=CDL_DokNumer and CDL_DokTyp = 960
	left join cdn.UmwNag on UmN_Id=CDL_CRMNumer 
	left join	

			(select
			UmP_UmNId,
			sum(UmP_WartoscPoRabacie) as 'Um Wartość Waluta',
			UmP_Waluta as 'Waluta UM'
			from cdn.UmwPozycje
			group by UmP_UmNId, UmP_Waluta) 
			um_pozycje on um_pozycje.UmP_UmNId = UmN_Id 

	join cdn.kntkarty on knt_gidnumer = zan_kntnumer
	left join cdn.prckarty on ZaN_OpiNumer = prc_gidnumer and ZaN_OpiTyp = 944
	join cdn.atrybuty ado on ado.Atr_obinumer = zan_gidnumer and ado.atr_obityp = zan_gidtyp and ado.Atr_AtkId = 196
	left join cdn.atrybuty aoo on aoo.Atr_obinumer = zan_gidnumer and aoo.atr_obityp = zan_gidtyp and aoo.Atr_AtkId = 20
	left join cdn.atrybuty ato on ato.Atr_obinumer = zan_gidnumer and ato.atr_obityp = zan_gidtyp and ato.Atr_AtkId = 145
	join cdn.atrybuty apd on apd.Atr_obinumer = zan_gidnumer and apd.atr_obityp = zan_gidtyp and apd.Atr_AtkId = 16
	left join cdn.atrybuty um on um.Atr_obinumer = zan_gidnumer and um.atr_obityp = zan_gidtyp and um.Atr_AtkId = 23
	join cdn.atrybuty osos on osos.atr_obinumer = zan_gidnumer and osos.atr_obityp = 960 and osos.atr_atkid = 214
	left join cdn.atrybuty  t on t.atr_obinumer = zan_gidnumer and t.atr_obityp = zan_gidtyp and t.atr_atkid = 208

	left join 

			(select ath_id id,  max(cdn.tstodate(ath_timestamp,1)) data
			FROM cdn.AtrybutyHist
			join cdn.atrybuty on atr_id = AtH_id and ath_atkid=214 and ath_obityp=960
			group by ath_id) 
			atros on atros.id = osos.atr_id

	left join dbo.nat_abc_kl kl on kl.id = zan_kntnumer
	left join dbo.nat_abc_os so on so.id =  zan_kntnumer
	left join dbo.nat_abc_wr wr on wr.id =  zan_kntnumer

	where zan_gidtyp = 960 and zan_zamtyp = 768 

	group by zan_zamnumer,zan_zamseria, zan_zammiesiac, zan_zamrok, knt_akronim, zan_waluta, zan_kursl, zan_kursm, um.atr_wartosc, ato.atr_wartosc, kl.wartosc,  ZaN_DataWystawienia
	, isnull(aoo.Atr_Wartosc,''), isnull(apd.Atr_Wartosc,'')
	, isnull(um_pozycje.[Waluta UM],'')
	, isnull(um_pozycje.[Um Wartość Waluta],0), UmN_KursL
	, cast((UmN_KursL/100)*um_pozycje.[Um Wartość Waluta] as decimal(14,2))



GO

























